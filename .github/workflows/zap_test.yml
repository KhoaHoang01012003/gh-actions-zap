name: ZAP-Test

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      # Thiết lập Python 3.11
      - name: Setup Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: 3.11.5
      
      # Cài đặt thư viện Python (requests, owasp zap)
      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests python-owasp-zap-v2.4
      
      - name: Get working directory
        run: echo "$(pwd)"
      
      - name: Build Image
        run: docker build -t vulnerable-app .
      
      # Tải và cài đặt ZAP 2.14.0
      - name: Install OWASP ZAP 2.14.0
        run: |
          mkdir -p ./zap
          cd ./zap
          wget -N https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
          tar -zxvf ZAP_2.14.0_Linux.tar.gz
          rm ZAP_2.14.0_Linux.tar.gz

          # (Tuỳ chọn) Cài plugin exportreport (nếu cần)
          cd ZAP_2.14.0/plugin
          wget https://github.com/zaproxy/zap-extensions/releases/download/exportreport-v6/exportreport-alpha-6.zap

          # Quay lại thư mục gốc cài ZAP
          cd ..

          # Tạo file start-zap, stop-zap cho tiện (nếu cần)
          echo 'export PATH_ZAP_SH=./zap/ZAP_2.14.0/zap.sh' >> ~/.bashrc
          echo 'export ZAP_PORT=8090' >> ~/.bashrc

          echo 'sh -c "$PATH_ZAP_SH -daemon -host 0.0.0.0 -port $ZAP_PORT" > /dev/null & ' > start-zap
          echo 'sleep 40' >> start-zap

          echo 'sh -c "$PATH_ZAP_SH -host 0.0.0.0 -port $ZAP_PORT" > /dev/null & ' > start-gui-zap
          echo 'sleep 40' >> start-gui-zap

          echo 'pkill -f zap' > stop-zap

          chmod +x start-zap
          chmod +x start-gui-zap
          chmod +x stop-zap

          pwd
          ls -la

          
      # Chạy container trên cổng 5050
      - name: Run Docker Container
        run: |
          docker run -d -p 5050:5050 --name test-app vulnerable-app
          # Đợi một chút để container thật sự up
          sleep 10
          # Kiểm tra nhanh container
          curl -I http://localhost:5050 || exit 1
      
      # Khởi chạy ZAP daemon trên cổng 8090
      - name: Run ZAP Daemon
        run: |
          /home/runner/work/gh-actions-zap/gh-actions-zap/zap/ZAP_2.14.0/zap.sh -daemon \
            -host 0.0.0.0 \
            -port 8090 \
            -config api.addrs.addr.name=".*" \
            -config api.addrs.addr.regex=true \
            -config api.disablekey=true > /dev/null &
      
      # Đợi ZAP khởi động lâu hơn (tăng thời gian chờ)
      - name: Sleep for ZAP startup
        uses: jakejarvis/wait-action@master
        with:
          time: '40s'
      
      # (Tuỳ chọn) Nếu KHÔNG muốn requests đi qua proxy, huỷ biến môi trường:
      - name: Unset Proxy (optional)
        run: |
          unset HTTP_PROXY
          unset HTTPS_PROXY
          unset http_proxy
          unset https_proxy
      
      # (Hoặc) Nếu MUỐN đi qua proxy -> export HTTP_PROXY=...
      # - name: Set Proxy (optional)
      #   run: |
      #     export HTTP_PROXY=http://127.0.0.1:8090
      #     export HTTPS_PROXY=http://127.0.0.1:8090

      # Chạy script test automation (e2e_zap.py) 
      - name: Run Test Automation with ZAP
        run: |
          cd ./tests
          python e2e_zap.py
      
      # Upload report (chỉnh lại đường dẫn tuỳ thực tế)
      - name: "Upload Report"
        uses: actions/upload-artifact@v3
        with:
          name: zap-scan-report
          path: ./tests/zap-report.json
